<!DOCTYPE html>
<html lang="en">
<head id="master-head">
    <title>BeatCam - Capture</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#822BD9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon"  href="assets/img/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="assets/css/main.css">

    <style>
        body {
            background: var(--primary-color);
            color: #fff;
            font-family: 'Arial', sans-serif;
            text-align: center;
            padding-bottom: 100px;
        }

        /* Purple neon heading */
        .capture-header h1 {
            font-size: 32px;
            color: var(--main-color);
            text-shadow: 0 0 12px rgba(130, 43, 217, 0.7);
        }

        .capture-header p {
            color: #cccccc;
        }

        /* Waveform */
        .waveform-section canvas {
            width: 90%;
            height: 120px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin: 20px auto;
            box-shadow: 0 0 12px rgba(130,43,217,0.4);
        }

        /* Volume Meter */
        #volumeBar {
            width: 90%;
            height: 12px;
            background: #333;
            border-radius: 6px;
            margin: 10px auto;
            overflow: hidden;
        }

        #volumeBar::after {
            content: "";
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--main-color), #ff44aa);
            width: 0;
            transition: width .1s linear;
        }

        /* Beat flash indicator */
        #beatFlash {
            width: 30px;
            height: 30px;
            margin: auto;
            opacity: 0.2;
            border-radius: 50%;
            background: var(--main-color);
            box-shadow: 0 0 25px var(--main-color);
            transition: opacity 0.05s;
        }

        /* Camera Preview */
        #cameraView {
            width: 90%;
            border-radius: 18px;
            margin-top: 20px;
            background: black;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }

        /* Recording Timer */
        #recordTimer {
            font-size: 28px;
            color: #ff4444;
            text-shadow: 0 0 12px red;
            font-weight: bold;
        }

        /* Controls */
        .btn-record {
            background: #ff4444;
            border: none;
            padding: 15px 40px;
            border-radius: 40px;
            color: white;
            font-size: 20px;
            box-shadow: 0 0 12px rgba(255, 68, 68, .7);
        }

        .btn-stop {
            background: #333;
            color: white;
            padding: 15px 40px;
            border-radius: 40px;
            font-size: 20px;
            border: 1px solid #ccc;
        }

        /* Accelerometer section */
        .accelerometer-section {
            margin-top: 20px;
        }

        .accelerometer-section h3 {
            color: var(--main-color);
            text-shadow: 0 0 8px rgba(130,43,217,0.7);
        }
    </style>
</head>

<body>
<!-- Main Header -->
<header id="master-header"></header>

<!-- Page Header -->
<header class="capture-header">
    <h1>Capture</h1>
    <p>Record video with live audio & motion feedback</p>
</header>

<!-- CAMERA CONTROLS -->
<section class="camera-settings container mt-3 mb-3">
    <div class="row g-3">

        <!-- Switch Camera -->
        <div class="col-4 text-center">
            <button id="switchCamera" class="btn btn-outline-light w-100"
                    style="border-color:var(--main-color); color:white; box-shadow:0 0 8px var(--main-color);">
                üîÑ Switch
            </button>
        </div>

        <!-- Resolution -->
        <div class="col-4 text-center">
            <select id="resolutionSelect" class="form-select"
                    style="background:var(--primary-color); color:white; border:1px solid var(--main-color);">
                <option value="480p">480p</option>
                <option value="720p" selected>720p</option>
                <option value="1080p">1080p</option>
            </select>
        </div>

        <!-- Filters -->
        <div class="col-4 text-center">
            <select id="filterSelect" class="form-select"
                    style="background:var(--primary-color); color:white; border:1px solid var(--main-color);">
                <option value="none">No Filter</option>
                <option value="bw">Black & White</option>
                <option value="vivid">Vivid</option>
                <option value="purple">Purple</option>
                <option value="blur">Soft Blur</option>
            </select>
        </div>
    </div>

    <!-- SPOTIFY CONNECT BUTTON -->
    <div class="text-center mt-3">
        <button id="spotifyConnectBtn" class="btn btn-success"
                style="border-radius: 10px; font-size: 18px;">
            üéß Connect to Spotify
        </button>
    </div>
</section>

<!-- Waveform -->
<section class="waveform-section">
    <canvas id="waveformCanvas"></canvas>
</section>

<!-- Volume Meter -->
<section class="volume-section">
    <div id="volumeBar"></div>
</section>

<!-- Beat Indicator -->
<section class="beat-indicator">
    <div id="beatFlash"></div>
    <p>Beat Detection</p>
</section>

<!-- Camera Preview -->
<section class="camera-preview">
    <video id="cameraView" autoplay playsinline muted></video>
</section>

<!-- Timer -->
<div class="timer">
    <span id="recordTimer">00:00</span>
</div>

<!-- Controls -->
<div class="capture-controls">
    <button class="btn-record" id="startRecord">‚óè Record</button>
    <button class="btn-stop" id="stopRecord" disabled>‚ñ† Stop</button>
</div>

<!-- Accelerometer -->
<section class="accelerometer-section">
    <h3>Device Motion</h3>

    <!-- NEW: Required for iOS motion permission -->
    <button id="enableMotionBtn"
            class="btn btn-warning mb-2"
            style="border-radius:10px; font-weight:bold;">
        üì± Enable Motion Effects
    </button>

    <p>X: <span id="accX">0</span></p>
    <p>Y: <span id="accY">0</span></p>
    <p>Z: <span id="accZ">0</span></p>
</section>

<div id="bottomNav"></div>

<!-- Scripts -->
<script src="assets/js/app.js"></script>
<script src="assets/js/capture/microphone.js"></script>
<script src="assets/js/capture/accelerometer.js"></script>
<script src="assets/js/capture/camera.js"></script>
<script src="assets/js/permissions.js"></script>
<script src="pwa-init.js"></script>

<!-- SPOTIFY JS -->
<script src="assets/js/capture/spotify.js"></script>
<script>
    // Handle Spotify Login Button
    const btn = document.getElementById("spotifyConnectBtn");
    btn.onclick = () => {
        if (localStorage.getItem("spotify_access_token")) {
            localStorage.removeItem("spotify_refresh_token");
            localStorage.removeItem("spotify_access_token");
            localStorage.removeItem("spotify_expires_at");
            localStorage.removeItem("spotify_verifier");
            window.location.href = "capture.html"
        } else {
            connectSpotify();
            breakLoop = false;
        }
    };

    // Handle Redirect after Spotify Login
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
        fetchAccessToken(code).then(() => {
            console.log("Spotify Connected ‚úî");
            getCurrentlyPlaying().then(song => {
                console.log(song)
                startDisplayLoop();
            });
        });
    }

    // NEW ‚Äî iOS Motion Permission Activation
    document.getElementById("enableMotionBtn").onclick = () => {
        startAccelerometer();  // must be triggered by user gesture
    };
</script>

<!-- START/STOP -->
<script>
    const startRecordBtn = document.getElementById('startRecord');
    const stopRecordBtn = document.getElementById('stopRecord');
    startRecordBtn.onclick = async () => {
        await startCamera();

        startRecording();
        startTimer();
        startRecordBtn.disabled = true;
        stopRecordBtn.disabled = false;
    };
    stopRecordBtn.onclick = async () => {
        if (!mediaRecorder) return;
        mediaRecorder.stop();

        if (isRecording) {
            isRecording = false;
            stopCamera();
            stopTimer();
            startRecordBtn.disabled = false;
            stopRecordBtn.disabled = true;
            console.log("‚èπ Recording stopped");
            window.location.href = "studio.html";
        }
    };
</script>

</body>
</html>
